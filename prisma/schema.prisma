generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  image     String?
  createdAt DateTime  @default(now())
  projects  Project[]
}

model Project {
  id           String         @id @default(uuid())
  name         String
  createdAt    DateTime       @default(now())
  owner        User           @relation(fields: [ownerId], references: [id])
  ownerId      String
  pageViews    PageView[]
  visitors     Visitor[]
  locations    Location[]
  dailyStats   DailyStats[]
  referrers    Referrer[]
  customEvents CustomEvent[]

  @@unique([ownerId, name])
}

model PageView {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  url       String
  timestamp DateTime @default(now())

  @@index([projectId])
  @@index([url])
  @@index([timestamp])
}

model Visitor {
  id               String   @id @default(uuid())
  projectId        String
  project          Project  @relation(fields: [projectId], references: [id])
  visitorId        String   // Unique identifier for the visitor (e.g., hashed IP + user agent)
  userAgent        String
  language         String
  platform         Platform
  screenResolution String
  colorDepth       Int
  firstVisit       DateTime @default(now())
  lastVisit        DateTime @default(now())

  @@unique([projectId, visitorId])
  @@index([projectId])
  @@index([lastVisit])
}

model Location {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  visitorId String
  ip        String?
  latitude  Float?
  longitude Float?
  accuracy  Float?
  city      String?
  region    String?
  country   String?
  timestamp DateTime @default(now())

  @@index([projectId])
  @@index([country])
  @@index([timestamp])
}

model DailyStats {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  date      DateTime
  views     Int      @default(0)
  visitors  Int      @default(0)
  newVisitors Int    @default(0)

  @@unique([projectId, date])
  @@index([date])
}

model Referrer {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  url       String
  count     Int      @default(0)

  @@unique([projectId, url])
  @@index([url])
}

model CustomEvent {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  name      String
  count     Int      @default(0)
  timestamp DateTime @default(now())

  @@unique([projectId, name])
  @@index([name])
  @@index([timestamp])
}

enum Platform {
  DESKTOP
  MOBILE
  TABLET
}